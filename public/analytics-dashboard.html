<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Mauro's Toolbox</title>
    <link href="https://fonts.googleapis.com/css?family=Oswald:700|Roboto:400&family=Poppins:wght@400;700&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', 'Poppins', 'Roboto', Arial, sans-serif;
            background: #f7f7f7;
            min-height: 100vh;
            color: #222;
        }

        .header {
            background: #fff;
            padding: 2.5rem 4rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0 0 24px 24px;
        }

        .header h1 {
            font-family: 'Poppins', 'Oswald', Arial, sans-serif;
            color: #111;
            font-size: 4rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-shadow: 0 4px 18px rgba(0,0,0,0.10);
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            padding: 0.5rem 2.5rem;
            display: inline-block;
        }

        .back-btn {
            background: #222;
            color: #fff;
            border: none;
            padding: 1.2rem 3.5rem;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Nunito', 'Poppins', 'Roboto', Arial, sans-serif;
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: 1.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: background 0.18s, color 0.18s, transform 0.18s, box-shadow 0.18s;
        }
        .back-btn:hover {
            background: #444;
            transform: scale(1.06) translateY(-2px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.13);
        }

        .container {
            max-width: calc(100vw - 100px);
            margin: 2rem 50px;
            padding: 0;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 2.5rem;
            height: calc(100vh - 160px);
        }

        .sidebar {
            background: #fff;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 18px rgba(0,0,0,0.07);
            overflow-y: auto;
            min-width: 340px;
        }

        .main-content {
            background: #fff;
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: 0 4px 18px rgba(0,0,0,0.07);
            overflow-x: auto;
            min-width: 0;
        }

        .section {
            margin-bottom: 2rem;
        }

        .section h3 {
            font-family: 'Nunito', 'Poppins', 'Roboto', Arial, sans-serif;
            color: #111;
            margin-bottom: 1rem;
            font-size: 2rem;
            font-weight: 700;
        }

        .query-templates {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            align-items: center;
        }

        .template-btn {
            background: #f8f9fa;
            border: 1.5px solid #222;
            padding: 1.3rem 2.2rem;
            border-radius: 16px;
            cursor: pointer;
            text-align: center;
            transition: background 0.18s, color 0.18s, border 0.18s, transform 0.18s, box-shadow 0.18s;
            font-family: 'Nunito', 'Poppins', 'Roboto', Arial, sans-serif;
            font-size: 1.18rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            margin: 0;
            width: 100%;
            max-width: 420px;
            min-width: 220px;
            line-height: 1.4;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            word-break: break-word;
        }
        .template-btn:hover, .template-btn.active {
            background: #222;
            color: #fff;
            border-color: #222;
            transform: scale(1.06) translateY(-2px);
            box-shadow: 0 16px 48px rgba(0,0,0,0.22);
        }

        .section label,
        .section b,
        .section .custom-query label,
        .section .visualization-controls label {
            color: #111 !important;
        }
        #stat-category-dropdown-container label {
            color: #111 !important;
        }
        .results-section h3,
        .main-content h3 {
            color: #111 !important;
        }

        .custom-query {
            margin-top: 1rem;
        }

        .custom-query textarea {
            width: 100%;
            height: 100px;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-family: 'Nunito', 'Poppins', 'Roboto', Arial, sans-serif;
            font-size: 0.9rem;
            resize: vertical;
        }

        .execute-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 0.5rem;
            width: 100%;
            font-family: 'Nunito', 'Poppins', 'Roboto', Arial, sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: background 0.18s, color 0.18s, transform 0.18s, box-shadow 0.18s;
        }
        .execute-btn:hover {
            background: #222;
            color: #fff;
            transform: scale(1.04) translateY(-1px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.13);
        }

        .results-section {
            margin-top: 2rem;
        }

        .chart-container {
            margin-top: 1rem;
            height: 600px;
            min-width: 700px;
            position: relative;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 5px;
            overflow: auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 1.08rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            max-width: 140px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .data-table th {
            background: #444;
            color: white;
            font-weight: bold;
        }

        .data-table th.percent-col, .data-table td.percent-col {
            max-width: 80px;
            text-align: right;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .visualization-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-group label {
            font-weight: bold;
            font-size: 0.9rem;
        }

        .control-group select,
        .control-group input {
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }

        .ml-section {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
        }

        .ml-section h4 {
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .prediction-result {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #111;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
        }

        .refresh-chart-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 0.8rem 2.2rem;
            border-radius: 10px;
            font-family: 'Nunito', 'Poppins', 'Roboto', Arial, sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: background 0.18s, color 0.18s, transform 0.18s, box-shadow 0.18s;
            margin: 1.2rem 0 1.2rem 0;
            cursor: pointer;
            display: block;
        }
        .refresh-chart-btn:hover {
            background: #222;
            color: #fff;
            transform: scale(1.04) translateY(-1px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.13);
        }

        @media (max-width: 1200px) {
            .container {
                max-width: 98vw;
                margin: 0 1vw;
                padding: 0 1rem;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
                height: auto;
            }
            .main-content {
                padding: 1rem;
            }
            .chart-container {
                min-width: 0;
                height: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Analytics Dashboard</h1>
        <button class="back-btn" onclick="window.location.href='index.html'">Terug naar Home</button>
    </div>

    <div class="container">
        <div class="dashboard-grid">
            <!-- Sidebar met query controls -->
            <div class="sidebar">
                <div class="section">
                    <h3>Query Templates</h3>
                    <div class="query-templates" id="query-templates">
                        <!-- Templates worden hier geladen -->
                    </div>
                </div>

                <div class="section">
                    <h3>Visualisatie</h3>
                    <div class="visualization-controls">
                        <div class="control-group">
                            <label>Chart Type:</label>
                            <select id="chart-type">
                                <option value="bar">Bar Chart</option>
                                <option value="line">Line Chart</option>
                                <option value="pie">Pie Chart</option>
                                <option value="scatter">Scatter Plot</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>X-Axis:</label>
                            <select id="x-axis">
                                <!-- Kolommen worden hier geladen -->
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Y-Axis:</label>
                            <select id="y-axis">
                                <!-- Kolommen worden hier geladen -->
                            </select>
                        </div>
                    </div>
                    <button class="execute-btn" onclick="updateChart()">Update Chart</button>
                </div>

                <div class="section">
                    <h3>Custom Query</h3>
                    <div style="background:#f8f9fa;padding:1rem;border-radius:6px;margin-bottom:1rem;color:#333;">
                        <b>Voorbeeldqueries:</b><br>
                        <ul style="margin:0 0 0 1.2em;padding:0;">
                            <li>Top 5 spelers: <code>SELECT TOP 5 player_name, team_code, PTS FROM dbo.nbaPlayerStats_Cleaned ORDER BY PTS DESC</code></li>
                            <li>Gemiddelde punten per team: <code>SELECT team_code, AVG(CAST(PTS AS FLOAT)) as avg_points FROM dbo.nbaPlayerTotals GROUP BY team_code</code></li>
                            <li>Efficiëntie: <code>SELECT player_name, PTS, MP, CAST(PTS AS FLOAT)/NULLIF(CAST(MP AS FLOAT),0) as efficiency FROM dbo.nbaPlayerTotals WHERE MP > 0 ORDER BY efficiency DESC</code></li>
                            <li><b>Aantal gespeelde wedstrijden per speler:</b> <code>SELECT player_name, COUNT(*) as games_played FROM dbo.nbaPlayerStats_Cleaned WHERE player_name IS NOT NULL AND PTS IS NOT NULL GROUP BY player_name ORDER BY games_played DESC</code></li>
                        </ul>
                        <div style="margin-top:0.5em;font-size:0.95em;">
                            Let op: Alleen numerieke kolommen kunnen als Y-as gebruikt worden in grafieken.<br>
                            <b>GS = Games Started</b> (aantal keer in de basisopstelling). Voor totaal aantal gespeelde wedstrijden, zie de query hierboven.
                        </div>
                    </div>
                    <div class="custom-query">
                        <textarea id="custom-query" placeholder="Voer je SQL query in..."></textarea>
                        <button class="execute-btn" onclick="executeCustomQuery()">Uitvoeren</button>
                    </div>
                </div>

                <div class="section">
                    <div class="ml-section">
                        <h4>Machine Learning</h4>
                        <p>ML features en voorspellingen (toekomstig)</p>
                        <button class="execute-btn" onclick="loadMLFeatures()">Laad ML Features</button>
                    </div>
                </div>
            </div>

            <!-- Main content met resultaten -->
            <div class="main-content">
                <div class="section">
                    <h3>Resultaten</h3>
                    <div id="results-container">
                        <div class="loading">Choose a query template, then tweak the visualization options in the "Visualisations" pane.</div>
                    </div>
                </div>

                <div class="section">
                    <h3>Visualisatie</h3>
                    <div class="chart-container">
                        <canvas id="chart"></canvas>
                    </div>
                </div>
                <button class="refresh-chart-btn" onclick="refreshChartFromTable()">Refresh Grafiek</button>
                <div class="section">
                    <h3>Data Tabel</h3>
                    <div id="table-container">
                        <!-- Data tabel wordt hier getoond -->
                    </div>
                </div>

                <!-- Voeg boven de resultaten sectie een dropdown toe, alleen zichtbaar bij relevante templates -->
                <div id="stat-category-dropdown-container" style="display:none;margin-bottom:1rem;">
                    <label for="stat-category-dropdown"><b>Rangschik op:</b></label>
                    <select id="stat-category-dropdown">
                        <option value="avg_pts">Punten (PTS)</option>
                        <option value="avg_trb">Rebounds (TRB)</option>
                        <option value="avg_ast">Assists (AST)</option>
                        <option value="avg_mp">Minuten (MP)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        let currentChart = null;
        let currentTemplate = null;
        let currentStatCategory = 'avg_pts';
        let sortColumn = null;
        let sortDirection = null; // 'asc', 'desc', of null
        let originalData = null;
        let currentPage = 0;
        const pageSize = 50;

        // Laad direct de cumulatieve top 10 grafiek bij laden van de pagina
        document.addEventListener('DOMContentLoaded', function() {
            loadQueryTemplates();
        });

        async function loadQueryTemplates() {
            const container = document.getElementById('query-templates');
            container.innerHTML = '';

            // Overview knop
            const overviewBtn = document.createElement('button');
            overviewBtn.className = 'template-btn';
            overviewBtn.innerHTML = `
                <strong>Overview Major Stat Categories Totals and Averages</strong><br>
                <small>Points, Rebounds, Assists, Steals, Blocks, Personal Fouls, Turnovers, Games Played</small>
            `;
            overviewBtn.onclick = () => executeQueryTemplate('Overview Major Stat Categories Totals And Averages');
            container.appendChild(overviewBtn);

            // Top Performances (ML) knop
            const mlBtn = document.createElement('button');
            mlBtn.className = 'template-btn';
            mlBtn.innerHTML = `
                <strong>Top Performances (ML)</strong><br>
                <small>Beste individuele wedstrijden volgens ML-performance score</small>
            `;
            mlBtn.onclick = () => executeTopPerformancesML();
            container.appendChild(mlBtn);

            // Aantal Gespeelde Wedstrijden knop
            const gamesPlayedBtn = document.createElement('button');
            gamesPlayedBtn.className = 'template-btn';
            gamesPlayedBtn.innerHTML = `
                <strong>Aantal Gespeelde Wedstrijden</strong><br>
                <small>Aantal gespeelde wedstrijden per speler (uit game logs)</small>
            `;
            gamesPlayedBtn.onclick = () => executeCustomQueryWithTemplate(`
                SELECT player_name, COUNT(*) as games_played 
                FROM dbo.nbaPlayerStats_Cleaned 
                WHERE player_name IS NOT NULL AND PTS IS NOT NULL 
                GROUP BY player_name 
                ORDER BY games_played DESC
            `);
            container.appendChild(gamesPlayedBtn);
        }

        function loadFallbackTemplates() {
            const container = document.getElementById('query-templates');
            container.innerHTML = '';
            
            const fallbackTemplates = [
                {
                    name: "Speler Performance Analyse",
                    description: "Analyseer speler statistieken per team",
                    query: `SELECT player_name, team_code, 
                        AVG(CAST(PTS AS FLOAT)) AS avg_pts,
                        AVG(CAST(AST AS FLOAT)) AS avg_ast,
                        AVG(CAST(TRB AS FLOAT)) AS avg_trb,
                        AVG(CAST(STL AS FLOAT)) AS avg_stl,
                        AVG(CAST(BLK AS FLOAT)) AS avg_blk,
                        AVG(CAST([FG%] AS FLOAT)) AS avg_fg,
                        AVG(CAST([3P%] AS FLOAT)) AS avg_3p,
                        AVG(CAST([FT%] AS FLOAT)) AS avg_ft,
                        COUNT(*) AS games_played
                    FROM dbo.nbaPlayerStats_Cleaned
                    WHERE player_name IS NOT NULL
                    GROUP BY player_name, team_code
                    ORDER BY avg_pts DESC`
                },
                {
                    name: "Team Vergelijking",
                    description: "Vergelijk teams op basis van gemiddelde statistieken",
                    query: `SELECT team_code,
                        COUNT(DISTINCT player_name) AS player_count,
                        AVG(CAST(PTS AS FLOAT)) AS avg_points,
                        AVG(CAST(TRB AS FLOAT)) AS avg_rebounds,
                        AVG(CAST(AST AS FLOAT)) AS avg_assists,
                        AVG(CAST(MP AS FLOAT)) AS avg_minutes
                    FROM dbo.nbaPlayerStats_Cleaned
                    WHERE player_name IS NOT NULL
                    GROUP BY team_code
                    ORDER BY avg_points DESC`
                },
                {
                    name: "Leiders per Categorie (Gemiddelde per Wedstrijd)",
                    description: "Spelers met hoogste gemiddelde per wedstrijd: PTS, RBS, AST, MP",
                    query: `WITH player_avgs AS (
                        SELECT
                            player_name,
                            team_code,
                            COUNT(*) AS games_played,
                            AVG(CAST(PTS AS FLOAT)) AS avg_pts,
                            AVG(CAST(AST AS FLOAT)) AS avg_ast,
                            AVG(CAST(MP AS FLOAT)) AS avg_mp,
                            AVG(CAST(ORB AS FLOAT) + CAST(DRB AS FLOAT)) AS avg_rbs
                        FROM dbo.nbaPlayerStats_Cleaned
                        WHERE player_name IS NOT NULL
                        GROUP BY player_name, team_code
                    )
                    SELECT 'PTS' AS category, player_name, team_code, games_played, avg_pts AS value
                    FROM player_avgs WHERE avg_pts = (SELECT MAX(avg_pts) FROM player_avgs)
                    UNION ALL
                    SELECT 'RBS', player_name, team_code, games_played, avg_rbs
                    FROM player_avgs WHERE avg_rbs = (SELECT MAX(avg_rbs) FROM player_avgs)
                    UNION ALL
                    SELECT 'AST', player_name, team_code, games_played, avg_ast
                    FROM player_avgs WHERE avg_ast = (SELECT MAX(avg_ast) FROM player_avgs)
                    UNION ALL
                    SELECT 'MP', player_name, team_code, games_played, avg_mp
                    FROM player_avgs WHERE avg_mp = (SELECT MAX(avg_mp) FROM player_avgs)
                    ORDER BY category`
                },
                {
                    name: "Aantal Gespeelde Wedstrijden",
                    description: "Aantal gespeelde wedstrijden per speler",
                    query: `SELECT player_name, team_code, COUNT(*) as games_played 
                        FROM dbo.nbaPlayerStats_Cleaned 
                        WHERE player_name IS NOT NULL 
                        GROUP BY player_name, team_code 
                        ORDER BY games_played DESC`
                }
            ];
            
            fallbackTemplates.forEach((template, index) => {
                const btn = document.createElement('button');
                btn.className = 'template-btn';
                btn.innerHTML = `
                    <strong>${template.name}</strong><br>
                    <small>${template.description}</small>
                `;
                btn.onclick = () => executeCustomQueryWithTemplate(template.query);
                container.appendChild(btn);
            });
        }

        function executeCustomQueryWithTemplate(query) {
            document.getElementById('custom-query').value = query;
            executeCustomQuery();
        }

        async function executeQueryTemplate(templateName) {
            try {
                currentTemplate = templateName;
                // Toon dropdown alleen bij relevante templates
                const dropdownContainer = document.getElementById('stat-category-dropdown-container');
                if (templateName === 'top_performers' || templateName === 'efficiency_analysis') {
                    dropdownContainer.style.display = '';
                } else {
                    dropdownContainer.style.display = 'none';
                }
                // Show loading
                document.getElementById('results-container').innerHTML = '<div class="loading">Laden...</div>';
                // Speciale handling voor Overview Major Stat Categories Totals And Averages
                if (templateName === 'Overview Major Stat Categories Totals And Averages') {
                    // Haal cumulatieve punten data op voor de grafiek
                    const chartResponse = await fetch('http://localhost:5000/api/cumulative/top10');
                    const chartResult = await chartResponse.json();
                    if (chartResult.success) {
                        showCumulativeLineChartStat(chartResult.data, chartResult.players, chartResult.dates, 'PTS');
                    }
                    // Haal ook de tabeldata op
                    const tableResponse = await fetch('http://localhost:5000/api/overview-totals');
                    const tableResult = await tableResponse.json();
                    if (tableResult.success) {
                        displayResults(tableResult.data, tableResult.columns, true); // true = skip chart
                    } else {
                        throw new Error(tableResult.error);
                    }
                    return;
                }
                // Bouw dynamische query voor top_performers
                let query = null;
                if (templateName === 'top_performers') {
                    query = `SELECT TOP 10
                        player_name,
                        team_code,
                        AVG(CAST(PTS AS FLOAT)) AS avg_pts,
                        AVG(CAST(TRB AS FLOAT)) AS avg_trb,
                        AVG(CAST(AST AS FLOAT)) AS avg_ast,
                        AVG(CAST(MP AS FLOAT)) AS avg_mp,
                        COUNT(*) AS games_played
                    FROM dbo.nbaPlayerStats_Cleaned
                    WHERE player_name IS NOT NULL
                    GROUP BY player_name, team_code
                    ORDER BY ${currentStatCategory} DESC`;
                } else if (templateName === 'efficiency_analysis') {
                    query = `SELECT
                        player_name,
                        team_code,
                        SUM(PTS) AS total_pts,
                        SUM(MP) AS total_mp,
                        CASE WHEN SUM(MP) > 0 THEN CAST(SUM(PTS) AS FLOAT) / SUM(MP) ELSE NULL END AS efficiency,
                        COUNT(*) AS games_played
                    FROM dbo.nbaPlayerStats_Cleaned
                    WHERE player_name IS NOT NULL
                    GROUP BY player_name, team_code
                    HAVING SUM(MP) > 0
                    ORDER BY efficiency DESC`;
                }
                let result;
                if (query) {
                    // Custom query voor deze templates
                    const response = await fetch('http://localhost:5000/api/query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query })
                    });
                    result = await response.json();
                } else {
                    // Standaard: API template
                    const response = await fetch(`http://localhost:5000/api/query-template/${templateName}`);
                    result = await response.json();
                }
                if (result.success) {
                    displayResults(result.data, result.columns);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                document.getElementById('results-container').innerHTML = `
                    <div class="error">Fout: ${error.message}</div>
                `;
            }
        }

        async function executeCustomQuery() {
            try {
                const query = document.getElementById('custom-query').value.trim();
                if (!query) {
                    alert('Voer een query in');
                    return;
                }
                
                document.getElementById('results-container').innerHTML = '<div class="loading">Uitvoeren...</div>';
                
                const response = await fetch('http://localhost:5000/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayResults(result.data, result.columns);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                document.getElementById('results-container').innerHTML = `
                    <div class="error">Fout: ${error.message}</div>
                `;
            }
        }

        function displayResults(data, columns, skipChart) {
            currentData = data;
            originalData = [...data]; // Initialize originalData when new data is loaded
            
            // Reset sorting state when new data is loaded
            sortColumn = null;
            sortDirection = null;
            currentPage = 0;
            
            // Update results container
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.innerHTML = `
                <div class="prediction-result">
                    <strong>Query Resultaat:</strong> ${data.length} rijen gevonden
                </div>
            `;
            
            // Update column selectors
            updateColumnSelectors(columns);
            
            // Display table
            displayTable(data, columns);
            
            // Create default chart, tenzij skipChart true is
            if (data.length > 0 && !skipChart) {
                createChart(data, columns);
            }
        }

        function updateColumnSelectors(columns) {
            const xAxis = document.getElementById('x-axis');
            const yAxis = document.getElementById('y-axis');
            xAxis.innerHTML = '';
            yAxis.innerHTML = '';
            columns.forEach(column => {
                const xOption = document.createElement('option');
                xOption.value = column;
                xOption.textContent = column;
                xAxis.appendChild(xOption);
            });
            // Alleen numerieke kolommen voor Y-as
            const numericColumns = columns.filter(col => {
                // Kijk naar de eerste 10 waarden om te bepalen of het numeriek is
                if (!currentData || currentData.length === 0) return false;
                for (let i = 0; i < Math.min(10, currentData.length); i++) {
                    const val = currentData[i][col];
                    if (val !== null && val !== undefined && val !== '' && isNaN(Number(val))) return false;
                }
                return true;
            });
            numericColumns.forEach(column => {
                const yOption = document.createElement('option');
                yOption.value = column;
                yOption.textContent = column;
                yAxis.appendChild(yOption);
            });
            // Default selectie: eerste kolom voor X, eerste numerieke voor Y
            if (columns.length > 0) xAxis.value = columns[0];
            if (numericColumns.length > 0) yAxis.value = numericColumns[0];
        }

        function displayTable(data, columns) {
            const container = document.getElementById('table-container');
            if (!data || data.length === 0) {
                container.innerHTML = '<p>Geen data gevonden</p>';
                return;
            }
            
            // Gebruik de data zoals die is (al gesorteerd door sortTableByColumn)
            let sortedData = [...data];
            
            // Paginatie: alleen de regels van de huidige pagina tonen
            const startIdx = currentPage * pageSize;
            const endIdx = startIdx + pageSize;
            const pageData = sortedData.slice(startIdx, endIdx);
            
            // Kolomnamen die als percentage worden getoond
            const percentCols = ['FG%', '3P%', '2P%', 'FT%', 'eFG%'];
            
            let tableHTML = '<table class="data-table"><thead><tr>';
            columns.forEach(column => {
                let arrow = '';
                if (sortColumn === column) {
                    arrow = sortDirection === 'asc' ? ' ▲' : ' ▼';
                }
                let colLabel = column === 'player_name' ? 'Player Name' : column;
                let thStyle = '';
                let percentClass = '';
                let onclick = '';
                
                if (column === 'player_name') {
                    thStyle = 'background:#333;color:#fff;';
                } else if (colLabel.startsWith('Total')) {
                    thStyle = 'background:#444;color:#fff;cursor:pointer;';
                    onclick = `onclick="sortTableByColumn('${column}')"`;
                } else if (colLabel.startsWith('Average')) {
                    thStyle = 'background:#888;color:#fff;';
                } else if (percentCols.includes(colLabel)) {
                    thStyle = 'background:#888;color:#fff;';
                    percentClass = 'percent-col';
                } else {
                    thStyle = 'background:#444;color:#fff;';
                }
                
                tableHTML += `<th class="${percentClass}" style="${thStyle}" ${onclick}>${colLabel}${arrow}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            pageData.forEach(row => {
                tableHTML += '<tr>';
                columns.forEach(column => {
                    let val = row[column];
                    // Afronden op 2 decimalen voor percentages
                    if (percentCols.includes(column) && val !== undefined && val !== null && val !== '') {
                        val = (Number(val) * 100).toFixed(2) + '%';
                    } else if (column.toLowerCase() === 'efficiency' && val !== undefined && val !== null && val !== '') {
                        val = Number(val).toFixed(2);
                    }
                    let percentClass = percentCols.includes(column) ? 'percent-col' : '';
                    tableHTML += `<td class="${percentClass}">${val || ''}</td>`;
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';
            
            // Navigatieknoppen onder de tabel
            const totalPages = Math.ceil(sortedData.length / pageSize);
            let navHTML = '';
            if (totalPages > 1) {
                navHTML = `<div style="display:flex;justify-content:center;align-items:center;margin:12px 0 0 0;gap:16px;">
                    <button onclick="prevTablePage()" ${currentPage === 0 ? 'disabled' : ''}>Vorige 50</button>
                    <span>Pagina ${currentPage + 1} van ${totalPages}</span>
                    <button onclick="nextTablePage()" ${currentPage >= totalPages - 1 ? 'disabled' : ''}>Volgende 50</button>
                </div>`;
            }
            
            container.innerHTML = tableHTML + navHTML;
        }

        // Dynamische sorteerfunctie met database-level sortering
        window.sortTableByColumn = async function(column) {
            console.log('sortTableByColumn aangeroepen met:', column);
            
            // Alleen sorteren als het een 'Total' kolom is
            if (!column.includes('Total')) {
                console.log('Geen Total kolom, sorteren uitgeschakeld');
                return;
            }
            
            // Sorteerstatus wisselen: desc -> asc -> uit -> desc ...
            if (sortColumn === column && sortDirection === 'desc') {
                sortDirection = 'asc';
            } else if (sortColumn === column && sortDirection === 'asc') {
                sortColumn = null;
                sortDirection = null;
            } else {
                sortColumn = column;
                sortDirection = 'desc';
            }
            
            // Controleer of we de Overview Major Stat Categories template gebruiken
            if (currentTemplate === 'Overview Major Stat Categories Totals And Averages') {
                console.log('Dynamische database sortering voor Overview template');
                
                try {
                    // Toon loading state
                    document.getElementById('results-container').innerHTML = '<div class="loading">Sorteren...</div>';
                    
                    const requestBody = {
                        sort_column: sortColumn || 'Total Points',
                        sort_direction: sortDirection || 'DESC'
                    };
                    
                    console.log('DEBUG: Sending sort request:', requestBody);
                    
                    // Roep de nieuwe sorted endpoint aan
                    const response = await fetch('http://localhost:5000/api/overview-totals/sorted', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    
                    const result = await response.json();
                    
                    console.log('DEBUG: Received response:', result);
                    
                    if (result.success) {
                        // Update de data met de nieuwe gesorteerde data
                        currentData = result.data;
                        originalData = [...result.data];
                        currentPage = 0;
                        
                        // Update de tabel
                        displayTable(currentData, result.columns);
                        
                        // Update de cumulatieve grafiek
                        if (sortColumn && sortDirection) {
                            console.log('Calling updateCumulativeChartFromSort with:', sortColumn, sortDirection);
                            updateCumulativeChartFromSort();
                        }
                        
                        // Clear loading state
                        document.getElementById('results-container').innerHTML = `
                            <div class="prediction-result">
                                <strong>Query Resultaat:</strong> ${result.data.length} rijen gevonden
                                <br><small>Gesorteerd op: ${result.sort_column} (${result.sort_direction})</small>
                            </div>
                        `;
                        
                        console.log(`Database sortering voltooid: ${sortColumn} (${sortDirection})`);
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Fout bij database sortering:', error);
                    document.getElementById('results-container').innerHTML = `
                        <div class="error">Fout bij sorteren: ${error.message}</div>
                    `;
                }
            } else {
                // Fallback naar client-side sortering voor andere templates
                console.log('Client-side sortering voor andere template');
                
                // Controleer of currentData bestaat en een array is
                if (!currentData || !Array.isArray(currentData) || currentData.length === 0) {
                    console.log('currentData is niet beschikbaar of leeg:', currentData);
                    alert('Geen data beschikbaar om te sorteren. Voer eerst een query uit.');
                    return;
                }
                
                if (!originalData) {
                    originalData = [...currentData];
                }
                
                // Sorteer de data op basis van de gekozen kolom
                if (sortColumn && sortDirection) {
                    currentData.sort((a, b) => {
                        let valA = a[sortColumn];
                        let valB = b[sortColumn];
                        
                        // Probeer als numeriek te sorteren
                        const numA = parseFloat(valA);
                        const numB = parseFloat(valB);
                        
                        if (!isNaN(numA) && !isNaN(numB)) {
                            // Numerieke sortering
                            if (sortDirection === 'asc') {
                                return numA - numB;
                            } else {
                                return numB - numA;
                            }
                        } else {
                            // String sortering
                            valA = valA ? valA.toString().toLowerCase() : '';
                            valB = valB ? valB.toString().toLowerCase() : '';
                            
                            if (valA < valB) {
                                return sortDirection === 'asc' ? -1 : 1;
                            } else if (valA > valB) {
                                return sortDirection === 'asc' ? 1 : -1;
                            } else {
                                return 0;
                            }
                        }
                    });
                    
                    console.log(`Client-side data gesorteerd op ${sortColumn} (${sortDirection})`);
                } else {
                    // Herstel originele volgorde
                    currentData = [...originalData];
                    console.log('Originele volgorde hersteld');
                }
                
            currentPage = 0;
            displayTable(currentData, Object.keys(currentData[0] || {}));
                
                // Update cumulatieve grafiek op basis van gesorteerde kolom
                if (sortColumn && sortDirection) {
                    console.log('Calling updateCumulativeChartFromSort with:', sortColumn, sortDirection);
                    updateCumulativeChartFromSort();
                }
            }
            
            // Highlight de actieve kolomkop kort
            setTimeout(() => {
                const ths = document.querySelectorAll('.data-table th');
                ths.forEach(th => {
                    if (th.textContent.replace(/[▲▼]/g, '').trim() === (sortColumn === 'player_name' ? 'Player Name' : sortColumn)) {
                        th.style.background = '#222';
                        th.style.color = '#fff';
                    } else {
                        th.style.background = '';
                        th.style.color = '';
                    }
                });
            }, 10);
        }
        
        async function updateCumulativeChartFromSort() {
            console.log('=== updateCumulativeChartFromSort START ===');
            console.log('sortColumn:', sortColumn);
            console.log('currentData:', currentData);
            
            // Controleer of currentData bestaat en een array is
            if (!currentData || !Array.isArray(currentData) || currentData.length === 0) {
                console.log('currentData is niet beschikbaar of leeg in updateCumulativeChartFromSort');
                console.log('Skipping cumulative chart update - no data available');
                return;
            }
            
            if (!sortColumn) {
                console.log('Early return: sortColumn missing');
                return;
            }
            
            // Map alleen de relevante kolommen naar SQL stat
            const statMap = {
                'Total Points': 'PTS',
                'Total Assists': 'AST',
                'Total Rebounds': 'TRB',
                'Total Steals': 'STL',
                'Total Blocks': 'BLK',
                'Total Turnovers': 'TOV',
                'Total Personal Fouls': 'PF'
            };
            
            const stat = statMap[sortColumn];
            if (!stat) {
                console.log('Geen mapping voor deze kolom, geen cumulatieve grafiek update:', sortColumn);
                return;
            }
            
            // Pak altijd de top 10 spelers uit de huidige (gesorteerde) tabel
            const topPlayers = (currentData && Array.isArray(currentData))
                ? currentData.slice(0, 10).map(row => row.player_name).filter(Boolean)
                : [];
            console.log('Top 10 players for chart (from sorted data):', topPlayers);
            if (!topPlayers.length) {
                console.log('No players found, returning');
                return;
            }
            try {
                console.log('Making API call to /api/cumulative/stat with:', {
                    players: topPlayers,
                    stat: stat
                });
                const response = await fetch('http://localhost:5000/api/cumulative/stat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ players: topPlayers, stat })
                });
                const result = await response.json();
                if (result.success) {
                    showCumulativeLineChartStat(result.data, result.players, result.dates, stat);
                    console.log('Cumulative chart updated successfully');
                } else {
                    console.error('Fout bij ophalen cumulatieve data:', result.error);
                }
            } catch (error) {
                console.error('Error updating cumulative chart:', error);
            }
            console.log('=== updateCumulativeChartFromSort END ===');
        }

        window.nextTablePage = function() {
            if (!currentData || currentData.length === 0) return;
            currentPage++;
            displayTable(currentData, Object.keys(currentData[0] || {}));
        }
        window.prevTablePage = function() {
            if (!currentData || currentData.length === 0) return;
            if (currentPage > 0) currentPage--;
            displayTable(currentData, Object.keys(currentData[0] || {}));
        }

        function createChart(data, columns) {
            const chartType = document.getElementById('chart-type').value;
            const xAxis = document.getElementById('x-axis').value;
            const yAxis = document.getElementById('y-axis').value;
            const ctx = document.getElementById('chart').getContext('2d');
            if (currentChart) currentChart.destroy();
            // Check of Y-as numeriek is
            const isNumeric = data.some(row => !isNaN(Number(row[yAxis])));
            if (!isNumeric) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '18px Oswald, Arial, sans-serif';
                ctx.fillStyle = '#C9082A';
                ctx.fillText('Geen geschikte numerieke data voor grafiek.', 30, 60);
                return;
            }
            // Voor scatterplot: alle data, anders max 20
            let chartData = [];
            if (chartType === 'scatter') {
                chartData = data
                    .filter(row => !isNaN(Number(row[xAxis])) && !isNaN(Number(row[yAxis])))
                    .map(row => ({
                        x: Number(row[xAxis]),
                        y: Number(row[yAxis]),
                        player_name: row.player_name || row.Name || '',
                        team_code: row.team_code || row.Team || '',
                        PTS: row.PTS,
                        MP: row.MP,
                        efficiency: row.efficiency
                    }));
                currentChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${yAxis} vs ${xAxis}`,
                            data: chartData,
                            backgroundColor: 'rgba(100,100,100,0.8)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${yAxis} vs ${xAxis}`
                            },
                            legend: {
                                labels: {
                                    color: '#444'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const d = context.raw;
                                        // Haal de labels van de assen op
                                        const xLabel = context.chart.options.scales.x.title.text;
                                        const yLabel = context.chart.options.scales.y.title.text;
                                        // Haal de waarden op
                                        const xVal = d.x !== undefined ? d.x : '-';
                                        const yVal = d.y !== undefined ? d.y : '-';
                                        const name = d.player_name || d.Name || '';
                                        const team = d.team_code || d.Team || '';
                                        return `${name}${team ? ', ' + team : ''}\n${xLabel}: ${xVal}\n${yLabel}: ${yVal}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { title: { display: true, text: xAxis } },
                            y: { title: { display: true, text: yAxis }, beginAtZero: true }
                        }
                    }
                });
            } else {
                chartData = data.slice(0, 20).map(row => ({
                    label: row[xAxis],
                    value: isNaN(row[yAxis]) ? 0 : parseFloat(row[yAxis])
                }));
                const labels = chartData.map(d => d.label);
                const values = chartData.map(d => d.value);
                currentChart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: yAxis,
                            data: values,
                            backgroundColor: 'rgba(100,100,100,0.8)',
                            borderColor: 'rgba(100,100,100,1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${yAxis} vs ${xAxis}`
                            },
                            legend: {
                                labels: {
                                    color: '#444'
                                }
                            }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        }

        function updateChart() {
            if (currentData) {
                const columns = Object.keys(currentData[0] || {});
                createChart(currentData, columns);
            }
        }

        async function loadMLFeatures() {
            try {
                const response = await fetch('http://localhost:5000/api/ml/features');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('results-container').innerHTML = `
                        <div class="prediction-result">
                            <strong>ML Features geladen:</strong> ${result.features.length} spelers<br>
                            <strong>Features:</strong> ${result.feature_columns.join(', ')}
                        </div>
                    `;
                    
                    displayResults(result.features, result.feature_columns);
                }
            } catch (error) {
                document.getElementById('results-container').innerHTML = `
                    <div class="error">Fout bij laden ML features: ${error.message}</div>
                `;
            }
        }

        // Event handler voor dropdown
        const statDropdown = document.getElementById('stat-category-dropdown');
        statDropdown.addEventListener('change', function() {
            currentStatCategory = this.value;
            if (currentTemplate === 'top_performers') {
                executeQueryTemplate('top_performers');
            }
        });

        async function refreshChartFromTable() {
            if (!currentData || currentData.length === 0) {
                alert('Geen data beschikbaar om grafiek te verversen. Voer eerst een query uit.');
                return;
            }
            // Bepaal de huidige sorteer-kolom (Total ... of Average ...)
            let statCol = sortColumn || Object.keys(currentData[0] || []).find(col => col !== 'player_name');
            // Map kolomnamen naar SQL kolomnamen
            const statMap = {
                'Total Points': 'PTS',
                'Total Rebounds': 'TRB',
                'Total Assists': 'AST',
                'Total Blocks': 'BLK',
                'Total Steals': 'STL',
                'Total Turnovers': 'TOV',
                'Total Personal Fouls': 'PF',
                'Average Points': 'PTS',
                'Average Rebounds': 'TRB',
                'Average Assists': 'AST',
                'Average Blocks': 'BLK',
                'Average Steals': 'STL',
                'Average Turnovers': 'TOV',
                'Average Personal Fouls': 'PF'
            };
            let stat = statMap[statCol] || 'PTS';
            // Pak de top 20 spelers uit de huidige tabel
            let sortedData = [...currentData];
            if (sortColumn) {
                sortedData.sort((a, b) => {
                    let valA = a[sortColumn];
                    let valB = b[sortColumn];
                    const numA = parseFloat(valA);
                    const numB = parseFloat(valB);
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return sortDirection === 'asc' ? numA - numB : numB - numA;
                    } else {
                        valA = valA ? valA.toString().toLowerCase() : '';
                        valB = valB ? valB.toString().toLowerCase() : '';
                        if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                        if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    }
                });
            }
            const topPlayers = sortedData.slice(0, 20).map(row => row.player_name).filter(Boolean);
            if (!topPlayers.length) return;
            // Haal cumulatieve data op voor deze spelers en stat
            const response = await fetch('http://localhost:5000/api/cumulative/stat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ players: topPlayers, stat })
            });
            const result = await response.json();
            if (result.success) {
                showCumulativeLineChartStat(result.data, result.players, result.dates, stat);
            } else {
                alert('Fout bij ophalen cumulatieve data: ' + result.error);
            }
        }

        function showCumulativeLineChartStat(data, players, dates, stat) {
            const ctx = document.getElementById('chart').getContext('2d');
            if (currentChart) currentChart.destroy();
            
            // Debug: log alle data
            console.log('Cumulative data:', data);
            console.log('Players:', players);
            console.log('Dates:', dates);
            console.log('Stat:', stat);
            
            // Gebruik de spelers die daadwerkelijk data hebben
            const availablePlayers = players.filter(p => {
                const playerData = data.filter(row => row.player_name === p);
                return playerData.length > 0;
            });
            
            console.log('Available players with data:', availablePlayers);
            
            const playerMap = {};
            
            availablePlayers.forEach((p, i) => {
                const playerRows = data.filter(row => row.player_name === p);
                if (playerRows.length > 0) {
                    // Forward fill array
                    const arr = Array(dates.length).fill(null);
                    const dateToStat = {};
                    
                    playerRows.forEach(row => {
                        // Gebruik altijd cumulative_stat voor de y-as
                        const statValue = row.cumulative_stat;
                        dateToStat[row.Date] = statValue;
                    });
                    
                    let lastValue = null;
                    dates.forEach((date, idx) => {
                        if (dateToStat[date] !== undefined && dateToStat[date] !== null) {
                            lastValue = dateToStat[date];
                        }
                        arr[idx] = lastValue;
                    });
                    
                playerMap[p] = {
                        data: arr,
                    label: p,
                        borderColor: `hsl(${i * 36},70%,40%)`,
                        pointRadius: 0,
                    tension: 0.2,
                        spanGaps: true
                };
                }
            });
            
            // Debug: toon de datasets
            const datasets = Object.values(playerMap);
            const allValues = datasets.flatMap(ds => ds.data.filter(v => v !== null));
            
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    spanGaps: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Cumulatief verloop van ${stat} voor top 10 spelers (gesorteerd op ${sortColumn || 'Total Points'})`
                        },
                        legend: {
                            labels: {
                                color: '#444',
                                font: { size: 13 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Datum' },
                            ticks: { color: '#444', maxTicksLimit: 12 }
                        },
                        y: {
                            title: { display: true, text: `Cumulatief ${stat}` },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        async function executeTopPerformancesML() {
            try {
                document.getElementById('results-container').innerHTML = '<div class="loading">Laden ML-performances...</div>';
                const response = await fetch('http://localhost:5000/api/top-performances-ml');
                const result = await response.json();
                if (result.success) {
                    // Alleen top 50 tonen
                    const data = result.data.slice(0, 50);
                    const columns = result.columns;
                    displayResults(data, columns);
                    showMLScatterPlot(data);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                document.getElementById('results-container').innerHTML = `<div class="error">Fout: ${error.message}</div>`;
            }
        }

        function showMLScatterPlot(data) {
            const ctx = document.getElementById('chart').getContext('2d');
            if (currentChart) currentChart.destroy();
            // x: speler + datum, y: ml_score
            const chartData = data.map(row => ({
                x: row['Date'] + ' - ' + row['player_name'],
                y: row['ml_score'],
                player_name: row['player_name'],
                date: row['Date'],
                team_code: row['team_code'],
                PTS: row['PTS']
            }));
            currentChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'ML Performance Score',
                        data: chartData,
                        backgroundColor: 'rgba(100,100,255,0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top 50 Beste Wedstrijden (ML-score)'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const d = context.raw;
                                    return `${d.player_name} (${d.date})\nML-score: ${d.y.toFixed(2)}\nPTS: ${d.PTS}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Speler - Datum' },
                            type: 'category',
                            ticks: { color: '#444', maxTicksLimit: 20 }
                        },
                        y: {
                            title: { display: true, text: 'ML Performance Score' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    </script>
</body>
</html> 